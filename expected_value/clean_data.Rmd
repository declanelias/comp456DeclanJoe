---
title: "clean_data"
output: html_document
date: '2022-11-23'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
library(dplyr)
library(lubridate)
library(tidyverse)
```


```{r}

load_book = function(league) {
    file = paste("betting_data/", league, "_raw.rdata", sep = "")
    env = new.env()
    nm = load(file, env)
    return(env[[nm]])
}


line.to.prob = function(line) {
  
  if_else(line < 0,
          abs(line) / (abs(line) + 100) * 100,
          100 / (line + 100) * 100)
  
}

prob.to.line = function(prob) {
  if_else(prob > .5,
          -1 * prob * 100 / (1 - prob),
          100 / prob- 100)
}

implied.prob = function(line1, line2) {
  prob1 = line.to.prob(line1)
  prob2 = line.to.prob(line2)
  
  return(prob1 / (prob1 + prob2))
}
```


### Load in the books
```{r}
ncaaf_raw = load_book("ncaaf")
```

### Get ML Data
```{r warning=FALSE}

ncaaf_raw = ncaaf_raw %>%
  filter(type == "game")


ncaaf_ml = ncaaf_raw %>%
  select(-c(teams, draw, total, away_total, away_over, away_under, home_total, 
            home_over, home_under, line_status,
            spread_away_line, spread_home_line, over, under))

ncaaf_ml = ncaaf_ml %>%
  filter(!is.na(winning_team_id))

ncaaf_ml = ncaaf_ml %>%
  mutate(home_prob_fair = implied.prob(ml_home, ml_away),
         away_prob_fair = 1 - home_prob_fair,
         home_team_win = if_else(winning_team_id == home_team_id, TRUE, FALSE),
         home_prob_vig = line.to.prob(ml_home) / 100,
         away_prob_vig = line.to.prob(ml_away) / 100,
         brier_score = (home_prob_fair - home_team_win) ^ 2)


consensus_data = ncaaf_ml %>% filter(book_id == 15)

get_consensus_win_prob = function(this.id) {
  return(
    consensus_data %>%
      filter(id == this.id) %>%
      getElement("home_prob_fair")
  )
}

ncaaf_ml = ncaaf_ml %>%
  group_by(id) %>%
  mutate(consensus = get_consensus_win_prob(id))

ncaaf_ml = ncaaf_ml %>%
  filter(!is.na(consensus))

ncaaf_ml = ncaaf_ml %>%
  mutate(home_prob_fair = if_else( abs(home_prob_fair - consensus) > .2,
                                   1 - home_prob_fair,
                                   home_prob_fair),
         away_prob_fair = 1 - home_prob_fair)

ncaaf_ml = ncaaf_ml %>%
  mutate(home_prob_vig = if_else( abs(home_prob_vig - consensus) > .2,
                                   1 - home_prob_vig,
                                   home_prob_vig),
         away_prob_vig = 1 - home_prob_vig)

ncaaf_ml = ncaaf_ml %>%
  mutate(home_prob_fair = ifelse( abs(home_prob_fair - consensus) > .2,
                                   NA,
                                   home_prob_fair)) %>%
  filter(!is.na(home_prob_fair))



save(ncaaf_ml, file = "betting_data/ncaaf_ml.rdata")
```



