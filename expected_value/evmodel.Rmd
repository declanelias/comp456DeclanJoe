---
title: "EV Model"
output: html_document
date: '2022-11-16'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(tidymodels)
```



```{r}
get_brier_score = function(df) {
  brier_data = df %>%
    group_by(book_id) %>%
    summarise(brier_score = mean(brier_score),
              n = n())
  
  brier_ref = (brier_data %>%
    filter(book_id != 5000) %>%
    summarise(brier_score = mean(brier_score)))$brier_score
  
  get_brier_ss = function(brier_score) {
    return(1 -  brier_score / brier_ref)
  }
    
  
  brier_data = brier_data %>%
    group_by(book_id) %>%
    mutate(brier_skill_score = get_brier_ss(brier_score)) %>% 
    ungroup()
  
  return(brier_data)
}
```

# College Football

```{r}
load("betting_data/ncaaf_ml_clean.rdata")
```


## First Test: Using the Brier Score as a weighted average

#### Create the Testing and Training Sets
```{r}

test_data = ncaaf_data %>%
  filter(season == 2021)

train_data = ncaaf_data %>%
  filter(season != 2021,
         season != 2022)
```

#### Train the data

```{r}
brier_train_data = get_brier_score(train_data)

brier_train_data = brier_train_data %>%
  filter(brier_skill_score > 0)
```


```{r}

get_brier_ss_of_book = function(this.book_id) {

  if (this.book_id %in% brier_train_data$book_id) {
    row = brier_train_data %>%
      filter(book_id == this.book_id)
    return(row$brier_skill_score)
  }
  return(0)
}

calc_weight_sum = function(book_id_list) {
  return(sum(map_dbl(book_id_list, get_brier_ss_of_book)))
}


calc_weighted_win_prob = function(book_id, win_prob) {
  
  brier_ss = map_dbl(book_id, get_brier_ss_of_book)
  
  return(brier_ss * win_prob)
}


model_data = test_data %>%
  mutate(weighted_home_win_prob = calc_weighted_win_prob(book_id, ml_home_implied_prob),
         weighted_home_ml = calc_weighted_win_prob(book_id, ml_home),
         weighted_away_ml = calc_weighted_win_prob(book_id, ml_away))


model_data = model_data %>%
  group_by(id) %>%
  summarise(id = mean(id),
            home_team_win = first(home_team_win),
            weighted_sum = calc_weight_sum(book_id),
            ml_home = sum(weighted_home_ml) / weighted_sum,
            ml_away = sum(weighted_away_ml) / weighted_sum,
            ml_home_implied_prob = sum(weighted_home_win_prob) / weighted_sum,
            ml_away_implied_prob = 1 - ml_home_implied_prob)

model_data = model_data %>%
  select(-c(weighted_sum)) %>%
  mutate(parent_name = "weighted_average",
         season = 2021,
         book_id = 5000,
         brier_score = (ml_home_implied_prob - home_team_win) ^ 2)

test_data = rbind(test_data, model_data)

get_brier_score(test_data)

save(model_data, file = "model_data/model_data_ncaaf.rdata")
load("model_data/model_data_ncaaf.rdata")
```


## Ev calculation


```{r}
get_model_implied_prob = function(list_id, implied_prob) {
  implied_prob[which(list_id == 5000)]
}

calc_ev = function(implied_win, implied_loss, ml_win, stake) {
  profit = if_else(ml_win < 0, 100 / abs(ml_win) * stake, ml_win)
  
  return(implied_win * profit - implied_loss * stake)
}

ev_data = test_data %>%
  group_by(id) %>%
  mutate(model_implied_home_prob = get_model_implied_prob(book_id, ml_home_implied_prob),
         model_implied_away_prob = get_model_implied_prob(book_id, ml_away_implied_prob),
         ev_home =  calc_ev(model_implied_home_prob, model_implied_away_prob, ml_home, 100),
         ev_away = calc_ev(model_implied_away_prob, model_implied_home_prob, ml_away, 100))



```



```{r}
load("betting_data/ncaaf_raw.rdata")
```

```{r}
betting_df %>%
  filter(season == 2021,
         id == 105605) %>%
  view()
```

