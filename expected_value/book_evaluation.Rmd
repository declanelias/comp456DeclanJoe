---
title: "book evaluation"
output: html_document
date: '2022-11-18'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(dplyr)
library(tidyverse)
```


Need to look at the books and decide which ones to use

## Load in data
```{r}
load("betting_data/book_id_data.rdata")
```

## Clean Book_data

For the legal books in the U.S, there are multiple different versions of the book based on the state becasue of legal issues, so to make sure i am not over counting books, i am going to take the average of each of these state books and use the aggregated values, because they should be identical, with maybe slight variations.


```{r Book Cleaning}
# removes horse track books (don't have any data on non-horseracing)
book_data_clean = BOOK_ID_DATA %>%
  filter(!(id %in% c(266, 251, 1434)))


# removes the state from display name passed in
remove_state = function(display_name, state) {
  if (length(state) > 1) {
    str_replace(display_name, regex("Canada$"), "")
  } else {
    pattern = paste(state,"$",sep = "")
    str_replace(display_name, regex(pattern), "")
  }
}

# cleans up cases not caught by the regex
clean_parent_name = function(id, parent_name) {
  if (id == 1073) {
    return("Caesars")
  } else if (id == 19){
    return("BetMGM")
  } else if (id == 1074) {
    return("Betway")
  } else if (id == 1072) {
    return("888Sport")
  } else (
    return(parent_name)
  )
}

# sets the parent name as the display name without the states
book_data_clean = book_data_clean %>%
  mutate(parent_name = map2_chr(display_name, states, remove_state))

# cleans up cases not caught by regex
book_data_clean = book_data_clean %>%
  mutate(parent_name = map2_chr(id, parent_name, clean_parent_name))

# remove space at the end
book_data_clean = book_data_clean %>%
  mutate(parent_name = str_replace(parent_name, regex(" $"), ""))
```

## Average the books

#### Helper function to load the book_data

```{r}
load_book = function(league) {
    file = paste("betting_data/", league, "_ml.rdata", sep = "")
    env = new.env()
    nm = load(file, env)
    return(env[[nm]])
}
```



### NCAAF

#### Load the data
```{r}
ncaaf_data = load_book("ncaaf")
```

#### Average the data

```{r}
parent_name_data = book_data_clean %>%
  select(c(id, parent_name)) %>%
  mutate(book_id = id) %>%
  select(-c(id))

ncaaf_data = left_join(ncaaf_data, parent_name_data, by = "book_id")

ncaaf_data = ncaaf_data %>%
  group_by(id, parent_name) %>%
  summarise(home_team_win = if_else(mean(favorite_home) > .5, TRUE, FALSE),
            favorite_win_prob = mean(favorite_win_prob),
            favorite_home = if_else(mean(favorite_home) > .5, TRUE, FALSE),
            favorite_win = if_else(mean(favorite_home) > .5, TRUE, FALSE),
            brier_score = mean(brier_score),
            season = mean(season)) %>%
  ungroup()

parent_name_list = ncaaf_data$parent_name %>% unique()

parent_name_df = as.data.frame(
  cbind(
    c(1:length(parent_name_list)), 
    parent_name_list)
  )

colnames(parent_name_df) = c("book_id", "parent_name")

ncaaf_data = left_join(ncaaf_data, parent_name_df, by = "parent_name")

ncaaf_data = ncaaf_data %>%
  mutate(book_id = as.numeric(book_id))



save(ncaaf_data, file = "betting_data/ncaaf_ml_clean.rdata")
```


### TODO: the rest of the leagues if i Have time
